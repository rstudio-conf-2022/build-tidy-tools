---
title: "üì¶ <br>Building tidy tools"
subtitle: "Day 1 Session 2: üè∑Ô∏èDocumentation - Minimal"
author: "Emma Rand and Ian Lyttle"
date: "<br>üîó [bit.ly/...](https://bit.ly/..)"
format:
  revealjs: 
    theme: [simple, emma.scss]
    slide-number: true
    chalkboard: true
    preview-links: auto
    footer: <https://bit.ly/..>
    margin: 0.07
    code-link: true
    code-line-numbers: false
execute:
  echo: true
  eval: false
bibliography: references.bib
---

# üè∑Ô∏è Document your package

## Learning Objectives

At the end of this section you will be able to:

::: small
-   Describe the different levels of package documentation
-   Describe what is in the `DESCRIPTION` file and know what to edit manually and which parts **`devtools`** will edit automagically
-   Document a function with Roxygen comments and use the **`devtools`** workflow to convert to "R documentation" format `.Rd`
-   Use some of the most common Roxygen tags
-   Describe, and document your package with, the common types of package dependencies
-   Add a citation file in Citation File Format (CFF)
:::

# Overview

## Levels of package documentation

-   Metadata: The `DESCRIPTION` file -- "what's in this package?"

-   Object documentation: for functions and data

<!-- for each of the exported functions and datasets in the package, along with examples of usage -->

-   Vignettes: Long form documentation

<!-- generally discussing how to use a number of functions from the - package together and/or how a package fits into a larger ecosystem of packages -->

-   **`pkgdown`** [@pkgdown] sites: Websites for your package!

# `DESCRIPTION`

## Sample `DESCRIPTION`

üé¨ Take a look at the `DESCRIPTION` for the following packages. What's common? What's different?

-   **`ggplot2`** [@ggplot2]
    -   [CRAN Package page](https://cran.r-project.org/web/packages/ggplot2/index.html)
    -   [DESCRIPTION on GitHub](https://github.com/tidyverse/ggplot2/blob/main/DESCRIPTION)
-   **`palmerpenguins`** [@palmerpenguins]
    -   [CRAN Package page](https://cran.r-project.org/web/packages/palmerpenguins/index.html)
    -   [DESCRIPTION on GitHub](https://github.com/allisonhorst/palmerpenguins/blob/master/DESCRIPTION)

## Metadata in `DESCRIPTION`

-   Title: One line, title case, with no period. Fewer than 65 characters.

-   Version

-   for release: MAJOR.MINOR.PATCH version.

-   for development version: MAJOR.MINOR.PATCH.9000

-   Authors\@R:

-   "aut" means author, "cre" means creator, "ctb" means contributor.

## Update `DESCRIPTION`

üé¨ Edit the title

\

üé¨ You should find that your information as an author is already included because you edited your `.RProfile` at the start of the session

## Update `DESCRIPTION`

::: small
``` default
Package: ussie
Title: Work with European Football League Data
Version: 0.0.0.9000
Authors@R: 
    person("Emma", "Rand", , "emma.rand@york.ac.uk", role = c("aut", "cre"),
           comment = c(ORCID = "0000-0002-1358-8275"))
Description: What the package does (one paragraph).
License: MIT + file LICENSE
Encoding: UTF-8
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.2.0
```
:::

## Metadata in `DESCRIPTION`

-   Description: One paragraph describing what the package does. Keep the width of the paragraph to 80 characters; indent subsequent lines with 4 spaces

-   License

-   Encoding: How to encode text, use UTF-8 encoding.

-   LazyData: Use true to lazy-load data sets in the package.

## Update `DESCRIPTION`

üé¨ Edit the description

. . .

::: small
``` default
Description: This is a demo package for the "Building Tidy Tools" workshop at 
    at rstudio::conf(2022L). It allows you to work with European football 
    league data supplied by the engsoccerdata package (Curley 2016)
```
:::

# Object documentation

## Object documentation

-   Object documentation is what you see when you use `?` or `help()`

-   Files are written in a special "R documentation" format: `.Rd`

-   `.Rd` resembles LaTeX,

## `man/uss_make_matches.Rd`

::: extrasmall
``` default
% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/matches.R
\name{uss_make_matches}
\alias{uss_make_matches}
\title{Make a standard league-play tibble}
\usage{
uss_make_matches(data_engsoc, country)
}
\arguments{
\item{data_engsoc}{obtained from {engsoccerdata}.}

\item{country}{\code{character} scalar, specifies the league.}
}
\value{
a tibble with columns \code{country}, \code{date}, \code{season}, \code{tier}, \code{home},
\code{visitor}, \code{goals_home}, \code{goals_visitor}.
}
\description{
Given a league-play data frame from {engsoccer}, returns a tibble with
standardised column-names and types, e.g. \code{date} is a \code{Date}.
}
\examples{
uss_make_matches(engsoccerdata::spain, "Spain")
}
```
:::

## Object documentation

ü•≥ We don't have to write it!!

. . .

-   We write "roxygen comments" in the `.R` files

-   Functions from **`roxygen2`** [@roxygen2] do the work but we can use **`devtools`** functions to call them

## Roxygen comments

::: extrasmall
``` default
#' Make a standard league-play tibble
#'
#' Given a league-play data frame from {engsoccer}, returns a tibble with
#' standardised column-names and types, e.g. `date` is a `Date`.
#'
#' @param data_engsoc  obtained from {engsoccerdata}.
#' @param country `character` scalar, specifies the league.
#'
#' @return a tibble with columns `country`, `date`, `season`, `tier`, `home`,
#'    `visitor`, `goals_home`, `goals_visitor`.
#' @export
#'
#' @examples
#' uss_make_matches(engsoccerdata::spain, "Spain")
uss_make_matches <- function(data_engsoc, country) {
  result <-
    data_engsoc |>
    tibble::as_tibble() |>
    dplyr::transmute(
      country = as.character(country),
      tier = as.integer(tier),
      season = as.integer(Season),
      date = as.Date(Date),
      home = as.character(home),
      visitor = as.character(visitor),
      goals_home = as.integer(hgoal),
      goals_visitor = as.integer(vgoal)
    )
  result
}
```
:::

-   the `#'` indicates it is a roxygen comment

## Object documentation workflow

-   Add roxygen comments to your `.R` files.

-   Run `devtools::document()` to convert roxygen comments to `.Rd` files.

-   Load the package with `devtools::load_all()`

-   Preview documentation with `?`

-   Repeat until the documentation looks the way you want.

## Document your function

üé¨ Open `matches.R`

üé¨ Put your cursor anywhere in the function and do Code \| Insert Roxygen Documentation (Ctrl-Alt-Shift-R)

## 

::: small
``` default
#' Title
#'
#' @param data_engsoc 
#' @param country 
#'
#' @return
#' @export
#'
#' @examples
uss_make_matches <- function(data_engsoc, country) {
  result <-
    data_engsoc |>
    tibble::as_tibble() |>
    dplyr::transmute(
      country = as.character(country),
      tier = as.integer(tier),
      season = as.integer(Season),
      date = as.Date(Date),
      home = as.character(home),
      visitor = as.character(visitor),
      goals_home = as.integer(hgoal),
      goals_visitor = as.integer(vgoal)
    )
  result
}
```
:::

## Roxygen comments and tags

-   `#'` indicates it is a roxygen comment

-   `@` indicates a roxygen tag

    -   `@param arg` --- describe the inputs
    -   `@examples`--- show how the function works
    -   `@seealso` --- point out related functions
    -   `@returns` --- describe the outputs
    -   `@param arg` --- is this a user visible function

## Document your function

üé¨ Give your function a title and a brief description

üé¨ Define the two parameters

üé¨ Describe what the function returns

## Our answer

::: small
``` default
#' Make a standard league-play tibble
#'
#' Given a league-play data frame from {engsoccer}, returns a tibble with
#' standardised column-names and types, e.g. `date` is a `Date`.
#'
#' @param data_engsoc  obtained from {engsoccerdata}.
#' @param country `character` scalar, specifies the league.
#'
#' @return a tibble with columns `country`, `date`, `season`, `tier`, `home`,
#'    `visitor`, `goals_home`, `goals_visitor`.
```
:::

üé¨ Save `matches.R`

## Build documentation

üé¨ Run `devtools::document()`

. . .

``` default
‚Ñπ Updating ussie documentation
‚Ñπ Loading ussie
Writing NAMESPACE
Writing uss_make_matches.Rd
Warning message:
[matches.R:13] @examples requires a value 
```

We will that fix later!

## Take a look 1

``` default
‚îú‚îÄ‚îÄ DESCRIPTION
‚îú‚îÄ‚îÄ LICENSE
‚îú‚îÄ‚îÄ LICENSE.md
‚îú‚îÄ‚îÄ man
‚îÇ   ‚îî‚îÄ‚îÄ uss_make_matches.Rd 
‚îú‚îÄ‚îÄ NAMESPACE
‚îú‚îÄ‚îÄ R
‚îÇ   ‚îî‚îÄ‚îÄ matches.R
‚îî‚îÄ‚îÄ ussie.Rproj
```

-   `NAMESPACE` now lists the exported function
-   `man/` directory has appeared
-   `uss_make_matches.Rd` has been written

## Take a look 2

üé¨ Load the package : `devtools::load_all()`

üé¨ Preview the documentation with `?uss_make_matches`

## Fix warning

``` default
Warning message:
[matches.R:13] @examples requires a value 
```

. . .

We need to add a usage example!

üé¨ Under `@examples`, add one example for using your function

. . .

``` default
#' @examples
#' uss_make_matches(engsoccerdata::spain, "Spain")
```

## Look again

üé¨ Save `matches.R`, run `devtools::document()` followed by `devtools::load_all()`

. . .

üé¨ Preview the documentation with `?uss_make_matches` and edit if needed

## `devtools::check()`

This is a good time to run R CMD check using `devtools::check()` to ensure our package is in full working order.

üé¨ `devtools::check()`

## 

::: extrasmall
``` default
‚îÄ‚îÄ R CMD check results ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ussie 0.0.0.9000 ‚îÄ‚îÄ‚îÄ‚îÄ
Duration: 29.5s

‚ùØ checking dependencies in R code ... WARNING
  '::' or ':::' imports not declared from:
    'dplyr' 'tibble'

‚ùØ checking for unstated dependencies in examples ... WARNING
  '::' or ':::' import not declared from: 'engsoccerdata'

‚ùØ checking R code for possible problems ... NOTE
  uss_make_matches: no visible binding for global variable 'tier'
  uss_make_matches: no visible binding for global variable 'Season'
  uss_make_matches: no visible binding for global variable 'Date'
  uss_make_matches: no visible binding for global variable 'home'
  uss_make_matches: no visible binding for global variable 'visitor'
  uss_make_matches: no visible binding for global variable 'hgoal'
  uss_make_matches: no visible binding for global variable 'vgoal'
  Undefined global functions or variables:
    Date Season hgoal home tier vgoal visitor

0 errors ‚úî | 2 warnings ‚úñ | 1 note ‚úñ
```
:::

We've gained a warning!

# Package dependecies

## Package dependecies

Our warnings are because e have used packages that we have not declared officially.

\

We need to document our package dependencies

## Package dependencies

-   **Imports:** must be installed for your package to work. If they're not, they will get installed.

-   **Suggests:** used by your package, but not required. Might provide data for examples, to run tests, build vignettes.

-   **Depends:** Avoid where possible. When your package requires a specific version of R, e.g. `Depends: R (>= 3.4.0)`. Think critically: downstream effects on packages that depend on your package.

## 

::: extrasmall
``` default
‚ùØ checking dependencies in R code ... WARNING
  '::' or ':::' imports not declared from:
    'dplyr' 'tibble'

‚ùØ checking for unstated dependencies in examples ... WARNING
  '::' or ':::' import not declared from: 'engsoccerdata'
```
:::

## Package dependencies

`use_package(package, type = "Imports")`

-   Type -- one of "Imports", "Depends", "Suggests", "Enhances", or "LinkingTo"

-   The default is "Imports"

## `usethis::use_package()`

üé¨ Use `usethis::use_package()` to add the **`dplyr`** package to `Imports`

```{r}
usethis::use_package("dplyr")
```

. . .

``` default
‚úî Adding 'dplyr' to Imports field in DESCRIPTION
‚Ä¢ Refer to functions with `dplyr::fun()`
```

Look how your `DESCRIPTION` file changed!

## `usethis::use_package()`

Note: we get reminded to "Refer to functions with `dplyr::fun()`"

That is, we do NOT use `library(dplyr)` to make functions available to our package.

. . .

üé¨ Repeat for **`tibble`**

```{r}
usethis::use_package("tibble")
```

## `devtools::check()`

üé¨ Run `devtools::check()` on your package again

## 

::: extrasmall
``` default
‚îÄ‚îÄ R CMD check results ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ussie 0.0.0.9000 ‚îÄ‚îÄ‚îÄ‚îÄ
Duration: 48.2s

‚ùØ checking for unstated dependencies in examples ... WARNING
  '::' or ':::' import not declared from: 'engsoccerdata'

‚ùØ checking R code for possible problems ... NOTE
  uss_make_matches: no visible binding for global variable 'tier'
  uss_make_matches: no visible binding for global variable 'Season'
  uss_make_matches: no visible binding for global variable 'Date'
  uss_make_matches: no visible binding for global variable 'home'
  uss_make_matches: no visible binding for global variable 'visitor'
  uss_make_matches: no visible binding for global variable 'hgoal'
  uss_make_matches: no visible binding for global variable 'vgoal'
  Undefined global functions or variables:
    Date Season hgoal home tier vgoal visitor

0 errors ‚úî | 1 warning ‚úñ | 1 note ‚úñ
```
:::

## Suggests

-   Are used by your package, but not required for it to work

-   Might provide data for examples

`matches.R`

    #' @examples
    #' uss_make_matches(engsoccerdata::spain, "Spain")

## Suggests

üé¨ Add **`engsoccerdata`**

```{r}
usethis::use_package("engsoccerdata", type = "Suggests")
```

¬†

::: extrasmall
``` default
‚úî Adding 'engsoccerdata' to Suggests field in DESCRIPTION
‚Ä¢ Use `requireNamespace("engsoccerdata", quietly = TRUE)` to test if package is installed
‚Ä¢ Then directly refer to functions with `engsoccerdata::fun()`
```
:::

## Suggests

-   Packages listed in Suggests are not automatically installed along with your package.

-   This means that you can't assume the package is available

## CITATION.cff

The **`cffr`** [@cffr] package will write a citation file in Citation File Format (CFF) [@druskat2021] from the description file.

```{r}
cffr::cff_write()

```

. . .

::: small
``` default
CITATION.cff generated
Adding  CITATION.cff to .Rbuildignore

cff_validate results-----
Congratulations! This .cff file is valid
```
:::

# üè∑Ô∏èYee haw! üè∑Ô∏è <BR> Your package has has documentation!

## Summary

::: small
-   A package has metadata and object documentation (essential), vignettes and **`pkgdown`** sites (optional)
-   Metadata is in the `DESCRIPTION`
    -   some fields need manual editing
    -   some fields are appropriately edited by **`devtools`** workflow functions
-   Objects like functions and data are documented with roxygen comments then turned into documentation with `devtools::document()`
    -   roxygen comments are indicated with `#'`
    -   roxygen tags start with `@`
:::

## Summary continued

::: small
-   Package dependencies need to be documented
    -   package dependencies are added with `use_package()`
    -   functions from dependencies are called with `pkg::function()`
    -   we don't use `library()`
-   `cffr::cff_write()` will write a citation file from the description file.
:::

## References {.extrasmall}
